<%= render "shared/navbar" %>


<div class="container my-4">
  <h1 class="mb-4">Group Chat</h1>

  <% if flash[:alert] %>
    <div class="alert alert-danger"><%= flash[:alert] %></div>
  <% end %>

  <div id="messages" class="mb-4">
    <% @messages.each do |message| %>
      <div
        class="card mb-2"
        data-testid="message-<%= message.id %>"
        data-message-id="<%= message.id %>">
        
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <span class="fw-bold">User <%= message.user_id %>:</span>
              <span><%= message.text %></span>
              <% if message.updated_at && message.updated_at > message.created_at %>
                <span class="text-muted fst-italic">(*edited)</span>
              <% end %>
            </div>
            <button
              class="btn btn-sm btn-outline-secondary"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#message-details-<%= message.id %>"
              aria-expanded="false"
              aria-controls="message-details-<%= message.id %>">
              Details
            </button>
          </div>

          <div
            id="message-details-<%= message.id %>"
            class="message-details collapse mt-2"
            data-testid="message-details-<%= message.id %>"
            aria-hidden="true">
            <strong>Details</strong>
            <div class="small text-muted" data-testid="message-time">
              Sent: <%= (message.time || message.created_at).strftime("%Y-%m-%d %H:%M") %>
            </div>


            <% if current_user && message.user_id == current_user.id %>
              <div class="mt-2">
                <span>Edit</span>
                <form action="<%= message_path(message) %>" method="post" class="d-flex gap-2">
                  <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                  <input type="hidden" name="_method" value="patch" />
                  <input
                    type="text"
                    name="text"
                    class="form-control form-control-sm flex-grow-1"
                    value="<%= message.text %>"
                    data-testid="edit-input-<%= message.id %>" />
                  <button type="submit" class="btn btn-sm btn-primary" data-testid="save-<%= message.id %>">
                    Save
                  </button>
                </form>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <form action="<%= create_itinerary_group_message_path(@itinerary_group) %>" method="post">
    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
    <div class="input-group">
      <input
        type="text"
        name="text"
        class="form-control"
        placeholder="Type your message..."
        value="<%= flash[:failed_text].to_s %>"
        data-testid="chat-input" />
      <button class="btn btn-primary" type="submit" data-testid="chat-send">Send</button>
    </div>
    <% if flash[:failed_text].present? %>
      <div class="text-danger small mt-1"><%= flash[:failed_text] %></div>
    <% end %>
  </form>
</div>
